# Dalton TPO Analysis Prompt — V9 

## Assumptions
- Symbols: ES, NQ, YM; input data are 5-min CSVs.
- Timestamps: tz-naive **US/Eastern** (no timezone conversion).
- **RTH window:** 09:30–16:00 — used for OPEN/CLOSE and all gap references.
- **Profiles:** Use **HL2** (OHLC midpoints). Do **not** use VWAP/EMA to build VA/POC.
- **Value Area:** **68%** via **adjacent expansion around the POC**.
- **Tick size:** ES 0.25, NQ 0.25, YM 1.00.
- **Gap logic:** RTH OPEN = first **09:30** bar’s **open**; PRIOR CLOSE = prior session **16:00** bar’s **close**.
- Project rule: If **any index closes its RTH gap**, emit a **Gap-Closure Warning** (potential order-flow flip) and reassess bias with ONH/ONL and VA edges.

## Tasks (per instrument)
1) **Pick session**
   - Choose the **latest RTH date** that has bars in 09:30–16:00.

2) **Today’s profile (HL2)**
   - Build volume-by-price profile on HL2.
   - Compute **POC, VAL, VAH** using **68% adjacent expansion**.
   - Report **POC/VAL/VAH** and **Value-Area Width (VAW = VAH − VAL)**.

3) **Gap analysis (RTH)**
   - `gap.direction ∈ {UP, DOWN, FLAT}`
   - `gap.points = (09:30 OPEN − prior 16:00 CLOSE)`
   - `gap.closed = True` if **any** RTH print trades through the prior close.

4) **HVN/LVN nodes**
   - Detect top **HVNs**/**LVNs** (local maxima/minima on the reindexed profile grid).
   - For each node, output:
     - `price`
     - **`range68: [low, high]`** (local 68% range centered at the node)
     - **`importance (0–5)`** (volume-based prominence for HVN; inverted for LVN)

5) **Previous-day reference**
   - Compute **previous_day_POC** from prior RTH profile.
   - Output `POC_vs_previous ∈ {opening above, opening at, opening below}`.

6) **POC rolling tracking**
   - **Developing POC (15-min cumulative)**:
     - From 09:30 onward, every 15 minutes record **POC/VAL/VAH** built on all data up to that checkpoint.
   - **Rolling 60-minute POC/VA**:
     - Sliding 60-min window series of **POC/VAL/VAH**.
   - Compute **`rolling_POC_trend_15m ∈ {higher, lower, flat}`** comparing first vs last POC.

7) **Composite context**
   - **Prior 1–3 sessions**: For each, output `POC/VAL/VAH` + HVN/LVN lists (with range68 & importance).
   - **Weekly composite (last 5 RTH sessions)**: Composite profile `POC/VAL/VAH` + HVN/LVN lists.

8) **Playbook (concise, numeric-anchored)**
   - **Bias**: Use POC posture vs previous POC, POC migration trend, and gap state.
   - **Entries**: Initiate at **VAH/VAL** or after **BOS + acceptance**; **avoid mid-profile** chases.
   - **Scaling**: First scale at **POC** (magnet); second toward **VAL/VAH** once accepted.
   - **Risk**:
     - **10:30 gate**: No counter-trend risk into a fresh impulse pre-10:30 unless clean **rejection + acceptance** at VA edge/gap.
     - **Short confirmations**: Need **(rejection at VAH/gap)** **AND** **(POC shift down OR VWAP rejection)**.
     - Emit **Gap-Closure Warning** if any index closes its gap (watch ONH/ONL & VA edges).

## Output Schema (per instrument)
{
  "instrument": "ES|NQ|YM",
  "session_date": "YYYY-MM-DD",
  "now_dt": "YYYY-MM-DD HH:MM:SS",

  "open_close_refs": {
    "RTH_open_09_30": 0.0,
    "prior_close_16_00": 0.0,
    "prior_close_date": "YYYY-MM-DD"
  },

  "gap": { "direction": "UP|DOWN|FLAT", "points": 0.0, "closed": true|false },

  "profile": { "POC": 0.0, "VAL": 0.0, "VAH": 0.0, "VA_width": 0.0 },

  "HVN_list": [
    { "price": 0.0, "range68": [0.0, 0.0], "importance": 0 }, ...
  ],
  "LVN_list": [
    { "price": 0.0, "range68": [0.0, 0.0], "importance": 0 }, ...
  ],

  "previous_day_POC": 0.0,
  "POC_vs_previous": "opening above|at|below prior POC",

  "rolling": {
    "developing_POC_15m": [
      { "dt": "YYYY-MM-DD HH:MM:SS", "POC": 0.0, "VAL": 0.0, "VAH": 0.0 }, ...
    ],
    "rolling_POC_60m": [
      { "dt": "YYYY-MM-DD HH:MM:SS", "POC_60m": 0.0, "VAL_60m": 0.0, "VAH_60m": 0.0 }, ...
    ],
    "rolling_POC_trend_15m": "higher|lower|flat"
  },

  "prior_sessions": [
    { "date": "YYYY-MM-DD", "POC": 0.0, "VAL": 0.0, "VAH": 0.0,
      "HVN_list": [...], "LVN_list": [...] }, ...
  ],

  "weekly_composite": {
    "dates": ["YYYY-MM-DD", ...],
    "POC": 0.0, "VAL": 0.0, "VAH": 0.0,
    "HVN_list": [...], "LVN_list": [...]
  },

  "playbook": {
    "bias": "...",
    "entries": "...",
    "scaling": "...",
    "risk_notes": [
      "Gap-closure warning if any index closed its gap.",
      "10:30 gate for counter-trend impulses.",
      "Shorts require rejection at VAH/gap AND (POC shift down OR VWAP rejection).",
      "On balance days, initiate at VAH/VAL or post-BOS + acceptance; POC = first scale/magnet."
    ]
  }
}

## Notes
- Keep timestamps **US/Eastern** and **RTH-anchored** references strict: 09:30 open & prior 16:00 close from OHLC bars.
- All value levels (POC/VAH/VAL, HVN/LVN) are derived from **price (HL2)** — not VWAP/EMA.
- When **any index** closes its RTH gap, reassess for **order-flow reversal**; monitor ONH/ONL, VA edges, and POC shifts.

