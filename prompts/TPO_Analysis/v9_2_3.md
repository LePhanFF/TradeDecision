# TPO Analysis — **v9.2.3** (v9.2.2 + embedded playbook)

**Summary:** v9.2.3 is an **exact feature copy** of v9.2.2 (TPO/VA/POC, IB & acceptance, DPOC, evidence tags, morph ledger, OTF detector, robust Gap analytics, audit meta, v9.2c-style tables and human summary) **except** that the **playbook is embedded** in this prompt so you don’t have to maintain a separate YAML file.

---

## Playbook Usage (embedded-first behavior)
- **Default:** Use the **embedded playbook** (below) to resolve `play_key` and populate `playbook.name`, `checklist`, `targets`, `invalidations`, `management`, `confidence`, `notes`.
- **Optional override:** If `playbook_override_path` is provided and successfully loaded (YAML with the same schema), use it **instead** of the embedded one. On any load failure, **fallback** to the embedded playbook.
- **Key construction:** `(day_type.baseline, ib_extension.side, ib_extension.ib_acceptance, gap.closed_by_cutoff, dominant_evidence_tag)` → `play_key`
- **Outputs:** The resolved play is emitted in JSON under `playbook` and summarized in the human report.

### Embedded Playbook (YAML)
```yaml
# tpo_playbook.v1.yaml
schema: tpo_playbook.v1
version: 1

# Key = "day_type,ib_side,ib_acceptance,gap_closed,dominant_evidence"
# day_type: D|P|b|B
# ib_side: Up|Down|None
# ib_acceptance: true|false           # our v9.2x acceptance test (>=0.25xIB & holds)
# gap_closed: true|false              # first touch of prior RTH close by cutoff
# dominant_evidence: E_* tag from v9.2c (e.g., E_DPOC_RUN_DOWN)

plays:

  # ========= BALANCED DAY TILTING DOWN (common) =========
  "D,Down,false,true,E_DPOC_RUN_DOWN":
    name: "Balanced → downside tilt (gap closed)"
    checklist:
      - "Bias short into **LVN below**; use **POC** as risk reference"
      - "Favor entries on **IB mid/IBL retests** or weak bounces"
      - "Avoid chasing if price returns **inside VA** quickly"
    targets: ["Nearest LVN below", "VAL − 0.3×IB", "Prior session HVN"]
    invalidations: ["Close back **inside IB**", "POC shifts up to **middle third**", "DPOC returns to VA next bracket"]
    management: ["Trail above prior bracket **high**", "Reduce risk after LVN reaction"]
    confidence: med
    notes: "DPOC run ≈ value migration down; gap closed removes mean-reversion pressure."

  "D,Down,false,false,E_DPOC_RUN_DOWN":
    name: "Balanced → downside tilt (gap open)"
    checklist:
      - "Favor shorts toward **gap-fill** & lower LVNs"
      - "If gap refuses to close on first attempt, keep a runner"
    targets: ["Gap-fill price", "LVN below", "VAL − 0.5×IB"]
    invalidations: ["Strong **IB re-entry** & close above IBL", "DPOC back inside VA"]
    management: ["Trail above prior bracket high", "Trim into gap-fill reaction"]
    confidence: med
    notes: "Open gap can serve as magnet but can also sustain trend if not filling quickly."

  # ========= BALANCED DAY TILTING UP =========
  "D,Up,false,true,E_DPOC_RUN_UP":
    name: "Balanced → upside tilt (gap closed)"
    checklist:
      - "Bias long on **IBH/POC retests** or shallow dips into LVN"
    targets: ["Nearest LVN above", "VAH + 0.3×IB"]
    invalidations: ["Close back **inside IB**", "POC shifts down to middle third"]
    management: ["Trail below prior bracket **low**"]
    confidence: med
    notes: "DPOC run up signals building value higher; gap closed removes fade pressure."

  "D,Up,false,false,E_DPOC_RUN_UP":
    name: "Balanced → upside tilt (gap open)"
    checklist:
      - "Favor longs **toward gap-fill** then VAH"
    targets: ["Gap-fill price", "VAH + 0.5×IB"]
    invalidations: ["IB re-entry and close under IBH", "DPOC snaps back inside VA"]
    management: ["Trail below prior bracket low"]
    confidence: med
    notes: "Open up-gap may either fill or persist; trade with structure."

  # ========= ACCEPTED IB BREAK (trend/initiative) =========
  "D,Up,true,*,E_DPOC_OUTSIDE_IB_UP":
    name: "Accepted above IB (initiative up)"
    checklist:
      - "Buy **pullbacks above IBH** (acceptance zone)"
      - "If single prints form below, place invalidation beneath them"
    targets: ["VAH extension", "Prior session HVN above"]
    invalidations: ["Close back **inside IB**", "One-timeframing **Down** starts"]
    management: ["Trail below last single-print base or prior bracket low"]
    confidence: high
    notes: "Per IB play: extension that **holds** outside IB indicates acceptance, not probe."

  "D,Down,true,*,E_DPOC_OUTSIDE_IB_DOWN":
    name: "Accepted below IB (initiative down)"
    checklist:
      - "Sell **bounces below IBL**; respect acceptance zone"
      - "Use single-print caps above for invalidation"
    targets: ["VAL extension", "Prior session HVN below"]
    invalidations: ["Close back **inside IB**", "One-timeframing **Up** starts"]
    management: ["Trail above last single-print cap or prior bracket high"]
    confidence: high
    notes: "Acceptance below IBL → price is being **accepted** lower."

  # ========= REJECTION AFTER PUSH =========
  "*,*,*,*,E_DPOC_RETURN_TO_VA":
    name: "Rejection—back inside value"
    checklist:
      - "Fade pushes back toward **POC** / opposite VA edge"
      - "Take profits at **POC/HVN**; expect balance"
    targets: ["POC", "Opposite VA edge"]
    invalidations: ["DPOC resumes run outside VA", "Fresh single prints against the fade"]
    management: ["Flat into POC reaction if rotation weakens"]
    confidence: low
    notes: "Outside push failed to hold; revert to balance expectations."

  # ========= DOUBLE-DISTRIBUTION RISK =========
  "B,*,false,*,E_DOUBLE_DISTRIBUTION_RISK":
    name: "Developing double-distribution (B-type risk)"
    checklist:
      - "Trade **between distributions**: fade into LVN, target opposing HVN"
      - "If DPOC shifts to upper node, switch bias to that node"
    targets: ["Upper/Lower **HVN**", "LVN midpoint"]
    invalidations: ["Acceptance inside the **split LVN** (no longer rejection)", "POC consolidates in middle third"]
    management: ["Reduce size in middle; add only at node edges"]
    confidence: med
    notes: "Two nodes forming; LVN acts as divider. Expect rotations."

  # ========= CLASSIC P/b DAYS (excess tail + value skew) =========
  "P,*,*,*,E_STABLE_DPOC_IN_VALUE":
    name: "P-day bias (excess low, distribution higher)"
    checklist:
      - "Lean long on **VAL retests**; avoid chasing into VAH"
    targets: ["POC", "VAH"]
    invalidations: ["POC shifts down to middle third", "Strong IB re-entry down"]
    management: ["Trail below VAL"]
    confidence: med

  "b,*,*,*,E_STABLE_DPOC_IN_VALUE":
    name: "b-day bias (excess high, distribution lower)"
    checklist:
      - "Lean short on **VAH retests**; avoid chasing into VAL"
    targets: ["POC", "VAL"]
    invalidations: ["POC shifts up to middle third", "Strong IB re-entry up"]
    management: ["Trail above VAH"]
    confidence: med

```

---

## Inputs (same as v9.2.2)
- `session_date` (YYYY-MM-DD)
- `session_type`: `RTH` (default) | `ETH`
- `pretend_cutoff` (ET), e.g., `14:00`
- **Symbols & files:** NinjaDataExport/v1 CSVs per symbol (tz-naive treated as **US/Eastern**, no conversion)
- **Tick sizes:** ES=0.25, NQ=0.25, YM=1.0 (override per symbol allowed)
- **Optional:** `playbook_override_path` (YAML). If provided and valid, it overrides the embedded playbook.

**CSV schema:** locate `timestamp, instrument, period, open, high, low, close, volume, ...` header (ignore preface rows). Parse `timestamp → _dt`. Use `open/high/low/close/volume`.

---

## Core Computations (identical to v9.2.2)
- **TPO** with 30-min brackets → letters `A..` (extend `A27` etc), ladder with one unique-letter print per price per bracket.
- **POC** = max unique letters. **70% VA** expand from POC.
- **IB** = A+B high/low. **Singles**: contiguous Count==1 at extremes. **Poor extremes**: top/bottom Count>1.
- **Day-type** P/b/B/D via tails + balance around POC.
- **IB extension & acceptance**: side/points/%IB; acceptance requires ≥0.25×IB beyond boundary **and** hold (≥60% closes beyond, or last close beyond if <6 bars).
- **VA skew**: POC thirds (lower/middle/upper).
- **Nodes**: HVN/LVN from TPO counts (top 3–5).
- **Gap**: prior RTH close vs today’s RTH open, points & direction, first close time if filled.
- **DPOC**: cumulative unique-letter counts by bracket; stability tie-breakers; per-bracket artifact CSV.
- **Evidence tags + why** (hints): `E_IB_ACCEPTANCE_*`, `E_DPOC_OUTSIDE_IB_*`, `E_DPOC_RUN_*`, `E_DPOC_RETURN_TO_VA`, `E_DOUBLE_DISTRIBUTION_RISK`, `E_STABLE_DPOC_IN_VALUE`.
- **Morph ledger**: `{time, event, reason}` for IB breaks/return, OTF start/stop, DPOC outside-IB hold/return, etc.
- **OTF detector**: bracket high/low rule; log first start/stop.
- **Audit meta**: version, inputs, cutoff, tick size, raw slice rows, **sha256** of parsed data, schema.

---

## Outputs (same as v9.2.2)
### 1) JSON (per symbol)
- `meta`, `ib`, `value_area`, `range`, `singles`, `poor_extremes`, `day_type`, `ib_extension` (with `ib_acceptance`), `gap`, `nodes`,
- `evidence` (array of `{tag, why}`), `dpoc` (first/last, shifts, run, outside_ib, acceptance, notes),
- `morph_ledger` (timestamped events),
- **`playbook`** (resolved from **embedded** or **override** YAML),
- `key_levels`, `comments_short`.

### 2) Human Summary (default & echoed)
Per symbol: Session, IB (height), VA + POC third, Range, **IB Extension + acceptance**, **Evidence** (tags + why), **Gap** line (direction/points/first close time), Singles (if present), Poor extremes flags, **Play (name + top checklist bullets)**, and a final **Context Read**.

### 3) Tables (default; v9.2c-compatible filenames)
- `v9_2c_Summary_Table.csv` — IB/VA/POC, Range, IB Ext side/%/acceptance, Evidence tags
- `v9_2c_Gap_Table.csv` — direction, points, closed?, first close time
- `v9_2c_Master_Table_FULL.csv` — merged view (IB/VA, Evidence+why, Gap, **Play fields**)
- `v9_2c_Master_Table_FIXED.csv` — same as FULL, but gaps recomputed from raw bars

### 4) Artifacts
- `SYMBOL_TPO_Profile_{date}_0930_to_{cutoff}.csv`
- `SYMBOL_Raw_{date}_0930_to_{cutoff}.csv`
- `SYMBOL_DPOC_Shifts_{date}_0930_to_{cutoff}.csv`
- `SYMBOL_TPO_v9_2_3_{date}_0930_to_{cutoff}.json`
- `TPO_v9_2_3_Human_Summary_{date}_0930_to_{cutoff}.md`

---

## Quality Gates
- **Cutoff-true:** every metric, file and table respects `pretend_cutoff`.
- **Gap robustness:** compute from raw slice + prior RTH close (not only cached JSON).
- **DPOC correctness:** cumulative unique-letter counts with stability tie-breakers; events timestamped per bracket.
- **OTF correctness:** strict bracket high/low rule; log start/stop once.
- **Playbook mapping:** prefer **embedded**; allow optional override path; fallback to embedded on error.
- **Auditability:** write `meta` with sha256 of raw slice and exact inputs.
- **No regressions:** all outputs from v9.2.2 must be present or superseded.
