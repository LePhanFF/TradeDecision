# TPO Analysis v9.1.6

## Adds
- **Gap close_time is mandatory** per index in the RTH Gap block. All other features retained (morph analysis, 15-min rolling POC, acceptance evidence, schema ingest, human summary).

## Data Ingestion (CSV two-line schema)
1) **Header layout**
   - Line 1 starts with `#schema:` (e.g., `#schema: ..., headerRow=2, ...`) → **skip line 1**
   - Line 2 is the actual CSV header (e.g., `timestamp,instrument,period,open,high,low,close,volume,...`)

2) **Datetime & timezone**
   - Column: `timestamp` (ISO-8601). Parse **tz-naive as US/Eastern**. **No timezone conversion**.

3) **Required columns (case-insensitive)**
   - `timestamp, open, high, low, close`
   - Optional: `volume, instrument, period, indicators (ema/rsi/atr/vwap)`

4) **Row validation & cleaning**
   - Coerce O/H/L/C/Volume to numeric; **drop** invalid OHLC rows.
   - If `low > high`, **swap once**; if still invalid, **drop**.
   - **Deduplicate** identical timestamps within the selected window using:
     - `open=first`, `high=max`, `low=min`, `close=last`, `volume=sum`
   - Sort strictly by `timestamp` ascending.

5) **Session selection**
   - Default: **RTH 09:30–16:00 ET** on the **most recent date with ≥ 12 five-minute bars**.
   - Support overrides: `session=ETH` or explicit `start_time`/`end_time`.

6) **Tick size & formatting**
   - Defaults: **ES** 0.25, **NQ** 1.00, **YM** 1.00 (override via `instrument`).
   - Print prices at the instrument’s natural precision; respect tick increments.

---

## Computation
1) **TPO counting**  
   One count per price level **touched** by each 5-min bar (no volume weighting); prices snapped to tick grid.

2) **POC / VAL / VAH (70% Value Area)**  
   - **POC** = price with maximum TPO.
   - Build value area by descending TPO (tie-break = proximity to POC) until cumulative **≥ 70%** → **VAL/VAH**.

3) **HVN / LVN**  
   Centered 3-point smoothing over TPO counts; report **top 6** prominent highs/lows.

4) **Initial Balance (IB)**  
   **09:30–10:30 ET** high & low from the same session.

5) **Single prints**  
   Contiguous price levels with **TPO == 1**. Report as price ranges.

6) **Poor highs / poor lows**  
   Topmost/bottommost price level **TPO ≥ 2**.

7) **Day-type + score**  
   Use peaks/bimodality, skewness, and **POC position within VA** to classify:
   - **B-day** if ≥ 2 peaks (score baseline 60 + 10×(peaks−2), cap 100)
   - **P-day** if positive skew & POC in lower VA
   - **b-day** if negative skew & POC in upper VA
   - Else **D-day (balanced)**

8) **Acceptance vs. rejection at value edges**  
   Count bars beyond **VAH** and below **VAL** with context:
   - ≤ 2 probes both sides → **Rejection both edges**
   - Many above only → **Acceptance above VA**
   - Many below only → **Acceptance below VA**
   - Many both sides → **Two-sided acceptance outside value**

---

## Rolling POC (15-minute intervals from RTH open)
- Start at **09:30 ET**; at **09:45, 10:00, 10:15, …** compute the **current cumulative-session POC** (time, poc, tpos).
- Summary: **Initial POC**, **Last POC**, **# Shifts**, **Net Direction** (up/down/flat).
- Use this as **morph evidence** (e.g., D → P or D → b or toward B when oscillating between nodes).

---

## RTH Gap Diagnostics (multi-index, **always include close_time**)
For **NQ, ES, YM** on the same session date:
1) **Prior RTH close**: last bar at/around **16:00 ET** in the **prior** RTH session.  
2) **Current RTH open**: **09:30 ET** open of current session.  
3) **Gap size**: `open_curr − prior_close` → report **points** and **ticks**.  
4) **Gap close**: first time intraday **trades through** prior close:
   - Gap-up closes when **low ≤ prior_close**
   - Gap-down closes when **high ≥ prior_close**
   - Record **close_time** (HH:MM ET) when first closed; **null** if not (yet) closed by the report cutoff.  
5) **Divergence warning**: if some indices close while others don’t →  
   `WARNING: Divergent RTH gap behavior — closed: [..]; open: [..] (reversal/rotation risk).`

---

## Output (strict order; **numeric values required**)
```
Session Date (ET): YYYY-MM-DD
Symbol: <ES|NQ|YM|...>
Tick Size: <number>

POC: <price>
VAL: <price>
VAH: <price>
Initial Balance High: <price>
Initial Balance Low: <price>

Top HVNs: [ [price, strength], ... up to 6 ]
Top LVNs: [ [price, weakness], ... up to 6 ]
Single Prints: [ [low1, high1], ... ]
Poor High: <true|false>
Poor Low: <true|false>

Day Type: <B-day|P-day|b-day|D-day>
Day Type Score: <0-100>
Reasoning (evidence): peaks=<int>, skew=<float>, POC position in VA=<0..1>

Acceptance/Rejection: <verdict>
Acceptance Evidence:
  bars>VAH=<int>, %time>VAH=<float>, closes>VAH=<int>, max_excess_above=<ticks>
  bars<VAL=<int>, %time<VAL=<float>>, closes<VAL=<int>, max_excess_below=<ticks>
  reentries_up=<int>, reentries_down=<int>
  POC rotation: {initial=<price>, last=<price>, shifts=<int>, dir=<up|down|flat>}

Rolling POC (15m from RTH open):
[ {"time":"09:45","poc":<price>,"tpos":<int>}, {"time":"10:00","poc":<price>,"tpos":<int>}, ... ]
Rolling POC Summary:
- Initial POC: <price> | Last POC: <price> | Shifts: <int> | Dir: <up|down|flat>

RTH Gap (multi-index):
- NQ: gap=<pts> (<ticks>), prior_close=<price>, closed=<true|false>, close_time=<HH:MM|null>
- ES: gap=<pts> (<ticks>), prior_close=<price>, closed=<true|false>, close_time=<HH:MM|null>
- YM: gap=<pts> (<ticks>), prior_close=<price>, closed=<true|false>, close_time=<HH:MM|null>
- Divergence: <none | WARNING: Divergent RTH gap behavior — closed: [..]; open: [..]>
```

---

## Human-Readable Summary (≤ 8 bullets)
- **Value map**: “VAL–VAH X–Y, **POC Z** (magnet).”
- **Structure**: “**IB H/L A/B** as early structure.”
- **Bias with evidence**: cite **peaks**, **skew**, **POC-in-VA**, **bars >VAH / <VAL**, plus **Rolling POC trend**.
- **Key levels**: POC / VAL / VAH / IB + 2–3 HVNs/LVNs (numbers).
- **If-then**: acceptance above **VAH** → nearest HVN; rejection back into value → rotate to **POC**; acceptance below **VAL** → LVNs/repairs.
- **Call morph** explicitly if Rolling POC + acceptance support a shift (e.g., “POC migrating up + acceptance >VA → morph toward **P** ”).

---

## Playbook Citations (optional)
If `/playbook` is available, append 1–3 short citations by title#section that match the verdict/morph:
```
Playbook Notes:
- strategies/Acceptance_vs_Rejection.md#two-sided — dwell-time & re-entries
- strategies/Day_Morphs.md#d-to-b — criteria & examples
- evidence/POC_Rotation_Cases.md#upper-lower-oscillation
```

---

## Failure Contract
If parsing fails, return only:
```
Error: <message>
Header: [col1, col2, ...]
Samples: [<raw timestamp 1>, <raw timestamp 2>, <raw timestamp 3>]
```
