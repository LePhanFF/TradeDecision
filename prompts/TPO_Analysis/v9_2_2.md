# TPO Analysis — **v9.2.2** (superset of v9.2.1 + v9.2c)

> **What’s new vs v9.2c**
> 1) **Playbook mapping (formalized):** emit a `playbook` block using `tpo_playbook.v1.yaml` keys (day-type, IB extension side/acceptance, gap state, DPOC evidence tags).
> 2) **Morph ledger:** rolling log of morph hints with **timestamps & reasons** (POC shifts, DPOC runs/holds, single-print fills, one-timeframing breaks, IB re‑entry).
> 3) **Gap analytics (complete):** prior-day RTH gap status + **first close time**; re‑open/recross notes if gap reopens.
> 4) **One‑timeframing detector:** auto flag OTF Up/Down by bracket and log first **break** time.
> 5) **Audit & reproducibility:** inputs, hash of raw slice, tick size, cutoff, version, and schema versions in `meta`.

> **Everything from v9.2c remains** (evidence tags + why, DPOC artifacts, Human Summary + tables, Gap line in summary, robust CSV parsing).

---

## Inputs
- `session_date` (YYYY‑MM‑DD)
- `session_type`: `RTH` (default) | `ETH`
- `pretend_cutoff` (ET), e.g., `14:00`
- **Symbols & files:** NinjaDataExport/v1 CSVs per symbol (tz‑naive treated as **US/Eastern**, no conversion)
- **Tick sizes:** ES=0.25, NQ=0.25, YM=1.0 (override per symbol allowed)

**CSV schema:** locate `timestamp, instrument, period, open, high, low, close, volume, ...` header (ignore preface rows). Parse `timestamp → _dt`. Use `open/high/low/close/volume`.

---

## Core Computations (carried from v9.2c)
- **TPO** with 30‑min brackets → letters `A..` (extend `A27` etc), ladder with one unique‑letter print per price per bracket.
- **POC** = max unique letters. **70% VA** expand from POC.
- **IB** = A+B high/low. **Singles**: contiguous Count==1 at extremes. **Poor extremes**: top/bottom Count>1.
- **Day‑type** P/b/B/D via tails + balance around POC.
- **IB extension & acceptance**: side/points/%IB; acceptance requires ≥0.25×IB beyond boundary **and** hold (≥60% closes beyond, or last close beyond if <6 bars).
- **VA skew**: POC thirds (lower/middle/upper).
- **Nodes**: HVN/LVN from TPO counts (top 3–5).
- **Gap**: prior RTH close vs today’s RTH open, points & direction, first close time if filled.
- **DPOC**: cumulative unique‑letter counts by bracket; stability tie‑breakers; per‑bracket artifact CSV.
- **Evidence tags + why** (hints): `E_IB_ACCEPTANCE_*`, `E_DPOC_OUTSIDE_IB_*`, `E_DPOC_RUN_*`, `E_DPOC_RETURN_TO_VA`, `E_DOUBLE_DISTRIBUTION_RISK`, `E_STABLE_DPOC_IN_VALUE`.

---

## New in v9.2.2

### A) Playbook mapping (formal)
- If `tpo_playbook.v1.yaml` is available, compute `play_key` from:  
  `(day_type.baseline, ib_extension.side, ib_extension.ib_acceptance, gap.closed_by_cutoff, dominant_evidence_tag)`
- Emit `playbook` with:
  - `play_key` (string)
  - `name` (if provided), `checklist`, `targets`, `invalidations`, `management`
  - `confidence`: low/med/high (map from evidence density + acceptance)
  - `notes`: short rationale
- If playbook file is missing, still emit `playbook` with `play_key` and heuristic `notes`.

### B) Morph ledger (timestamped)
Emit `morph_ledger` (array) of `{time_et, event, reason}` rows capturing:
- `ib_break_up|down`, `ib_reentry_up|down`
- `otf_up_start|stop`, `otf_down_start|stop`
- `dpoc_shift_up|down` (with delta), `dpoc_outside_ib_up|down_start|hold|return`
- `poc_shift` (finalized POC change relative to VA thirds)
- `single_print_fill_top|bottom`
- `double_distribution_hint` (two plateaus around an LVN)

### C) One‑timeframing detector
- Bracket‑to‑bracket highs/lows:
  - **OTF Up** while each bracket’s low ≥ prior bracket low.
  - **OTF Down** while each bracket’s high ≤ prior bracket high.
- Log first `*_start` and first opposing violation `*_stop` to `morph_ledger`.

### D) Gap analytics (complete)
- Record gap **direction**, **points**, and **first close time** (as before).
- If price **reopens** the gap later (recross), append a `gap_reopen` event with time to `morph_ledger`.

### E) Audit meta
- `meta`: { `version`: "v9.2.2", `session_date`, `session_type`, `cutoff_et`, `tick_size`, `source_file`, `raw_slice_rows`, `raw_slice_sha256`, `schema`: "NinjaDataExport/v1" }

---

## Outputs

### 1) **JSON** (per symbol)
```jsonc
{
  "symbol": "ES",
  "meta": { ... },
  "ib": {"low": 0.00, "high": 0.00, "height": 0.00},
  "value_area": {"val": 0.00, "poc": 0.00, "vah": 0.00, "poc_position": "lower|middle|upper"},
  "range": {"low": 0.00, "high": 0.00},
  "singles": {"down_tail": {"start": 0.00, "end": 0.00}, "up_tail": {"start": 0.00, "end": 0.00}},
  "poor_extremes": {"poor_low": false, "poor_high": false},
  "day_type": {"baseline": "D|P|b|B", "morph": {"from": null, "to": null, "reason": null}},
  "ib_extension": {"side": "Up|Down|None", "points": 0.00, "pct_of_ib": 0.0, "ib_acceptance": false},
  "gap": {"prior_close": 0.00, "today_open": 0.00, "points": 0.00, "direction": "up|down|flat", "closed_by_cutoff": true, "gap_close_time_et": "HH:MM"},
  "nodes": {"hvn": [{"price":0.00,"tpo":0}], "lvn": [{"price":0.00,"tpo":0}]},
  "evidence": [{"tag": "E_DPOC_RUN_DOWN", "why": "+0.32xIB over 3 brackets"}],
  "dpoc": {"first": 0.00, "last": 0.00, "shift_events": 0, "run": {"side": null, "ticks": 0.0, "length": 0}, "outside_ib": {"side": null, "held": false}, "acceptance": false, "notes": "..."},
  "morph_ledger": [{"time_et": "10:35", "event": "ib_break_up", "reason": ">=0.25xIB & closes>IBH"}],
  "playbook": {"play_key": "D,Down,false,true,E_DPOC_RUN_DOWN", "name":"...", "checklist": ["..."], "targets": ["..."], "invalidations": ["..."], "management": ["..."], "confidence": "med", "notes": "...", "source": "yaml|heuristic"},
  "key_levels": [{"label":"VAL","price":0.00},{"label":"POC","price":0.00},{"label":"VAH","price":0.00}],
  "comments_short": "Balanced with downside DPOC run; gap up closed 10:30."
}
```

### 2) **Human Summary** (default & echoed)
Per symbol (concise): Session, IB (height), Value Area + POC third, Range, **IB Extension + acceptance**, **Evidence** (tags + why), **Gap** line (direction/points/first close time), Singles (if present), Poor highs/lows (flags). Add a final one‑liner **Context Read** (balanced vs directional) with why.

### 3) **Tables (default)**
- `v9_2c_Summary_Table.csv` **(reuse name; schema compatible)**
- `v9_2c_Gap_Table.csv`
- `v9_2c_Master_Table_FULL.csv` + `v9_2c_Master_Table_FIXED.csv` *(keep names for downstream compatibility; they remain valid under v9.2.2)*

### 4) **Artifacts**
- `SYMBOL_TPO_Profile_{date}_0930_to_{cutoff}.csv`
- `SYMBOL_Raw_{date}_0930_to_{cutoff}.csv`
- `SYMBOL_DPOC_Shifts_{date}_0930_to_{cutoff}.csv`
- `SYMBOL_TPO_v9_2_2_{date}_0930_to_{cutoff}.json` *(and for older versions: `v9_2a`, `v9_2b`, `v9_2c`)*
- `TPO_v9_2_2_Human_Summary_{date}_0930_to_{cutoff}.md`

---

## Quality Gates
- **Cutoff‑true:** every metric, file and table respects `pretend_cutoff`.
- **Gap robustness:** compute from raw slice + prior RTH close (not only cached JSON).
- **DPOC correctness:** cumulative unique‑letter counts with stability tie‑breakers; events timestamped per bracket.
- **OTF correctness:** strict bracket high/low rule; log start/stop once.
- **Playbook mapping:** never fail hard if YAML missing—emit `play_key` + inferred notes; prefer YAML when available.
- **Auditability:** write `meta` with sha256 of raw slice and exact inputs.
- **No regressions:** all outputs from v9.2.1 and v9.2c must be present or superseded.
