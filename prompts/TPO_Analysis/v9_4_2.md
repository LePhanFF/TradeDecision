
# TPO Analysis v9.4.2 (Dalton + Nuances, with Embedded Playbook Library)

Purpose: Superset of v9.1.6 - v9.4.1. Nothing dropped. Adds 15-minute dPOC tracking, HVN/LVN mapping, and verbose JSON output.

## 0) Inputs & Validation
- Inputs: 5m OHLCV RTH (and optional ON); prior-day refs (H/L, TPO VAH/POC/VAL; Vol VA if available); tick size; ADR(20); optional peer symbols for cross-index gap checks.
- Validation: continuity, no duplicates, timezone aligned, outlier guard, prior refs present, ON integrity; peers optional (graceful skip).
- If any critical reference is missing, degrade gracefully (lower confidence, skip only the dependent metric).

## 1) Metrics (complete superset)
1. Open context
   - Opening location vs prior value/range; Opening Type (OD/OTD/ORR/OA).
2. Gap Module
   - Gap_Type: Outside_Prior_Range, Into_Prior_Range, Within_Prior_Value.
   - Gap_Size_Ticks, Gap_Size_%ADR, Gap_Fill_% (0-100), Time_to_First_50pct_Fill, Was_Fill_Completed.
3. Overnight Inventory
   - ON_Inventory_State: Too_Long/Too_Short/Balanced; ON-correction risk flag.
4. IB/RE
   - IB hi/lo/size; RE direction; Acceptance tiers: Provisional (2x15m + developing TPOs) vs Confirmed (>=1x30m + elongation/value drift).
5. Value Areas (TPO + Volume if available)
   - Today's VAH/POC/VAL; Volume VAH/POC/VAL; Value vs Yesterday: Higher/Lower/Overlapping/Inside/Outside.
6. Profile features
   - Shape: Trend, Double-Distribution, Neutral, Neutral-Extreme, Normal, Normal-Variation, D/Balance, P, b.
   - Excess & Poor High/Low; Spike & Spike Base; One-timeframing; Prominent POC; Revisit Magnets (singles, fat loops).
7. Developing POC (dPOC) - 15-minute tracking
   - Compute developing TPO counts up to each 15-minute checkpoint since RTH open.
   - Fields: dpoc_current, dpoc_start, dpoc_path_15m (array of [time, price]), dpoc_migration_ticks, dpoc_migration_speed_ticks_per_hr, dpoc_stability_ratio_last4, dpoc_jump (None/Up/Down).
8. HVN/LVN (support and resistance scaffolding)
   - Build a price-histogram (TPO count and/or volume). Identify local maxima (HVN) and minima (LVN) with a prominence threshold and minimum separation.
   - Report multiple nodes above and below current price: hvns_above, hvns_below, lvns_above, lvns_below (each item includes price, prominence, method: TPO/Volume, distance_in_ticks).
9. RTH Gap Close
   - rth_gap_dir (Up/Down/None), rth_gap_size_ticks, rth_gap_close_time, rth_gap_close_elapsed_min; peer_gap_closed list and earliest peer time if peers provided.
10. Balance Box
   - balance_box_top, balance_box_bottom, inside_balance flag for LAB/LBF and D-day logic.
11. 15m overlay
   - Early acceptance/rejection at IB extremes; provisional versus confirmed upgrade path.
12. Cross-index evidence
   - Track peer gap-close status to adjust confidence and caution notes.

## 2) Day-Type Taxonomy
- Trend (Up/Down), Double-Distribution, Neutral, Neutral-Extreme, Normal, Normal-Variation, Non-Trend/Balance (D-Day).
- Shape overlays: P (short covering), b (long liquidation). Morph states: P->B, b->B, D->P, D->b, Normal->Trend, Neutral->Extreme, Trend->DD.

## 3) Dynamic Confidence Scoring (0-100; verbose)
- Opening type: OD 30, OTD 22, ORR 18, OA 8 (cap 30).
- RE status: Confirmed +20; Provisional +12; Failure -10.
- Value vs Yesterday: Outside/Higher/Lower +12; Overlaps +5/-5; Inside 0.
- Volume alignment: +10 aligned; -5 misaligned.
- Day-type clarity: Trend +12; DD +8; Normal/Normal-Variation/Neutral/Neutral-Extreme +6; Balance +4.
- One-timeframing: +8 if active.
- 30m vs 15m confluence: +8 agree; -8 disagree.
- Prominent POC risk: -5 if trading away from it.
- Spike acceptance: +10 with bias; -6 against.
- Gap context: +10 (Outside_Prior_Range + OD/OTD + aligned ON + acceptance); -8 if value-inside + OA + early rejection.
- dPOC: +6 if migration aligns with attempted direction and persistent; -6 if stability high against a breakout idea.
- HVN/LVN: +5 if traversing LVN toward HVN supports idea; -5 if fighting HVN gravity or ignoring LVN rejection.
- Peer gap-close: +4 if peers supportive; -4 if peers contradict.
- Print sub-scores and a one-line rationale.

## 4) Playbook Selection and Supporting Evidence
- Use the embedded library below. A session can match multiple plays; select all compatible plays and rank by confidence.
- For each selected playbook, print:
  - Day Type, Bias, Confidence (score)
  - Triggers, Ideal Entry, Exit Targets, Invalidation
  - Supporting Evidence bullets referencing: Gap_Type, RE status, Value vs Yesterday, dPOC path, HVN/LVN nodes, Spike/Base, OTF, Balance Box edges, Peer gap-close.

## 5) Output (Verbose JSON + Human Table)
- JSON fields include:
  - session_date, instrument, validation, timeframes
  - metrics.open, metrics.gap, metrics.on_inventory, metrics.ib, metrics.re, metrics.value_area_tpo, metrics.value_area_volume,
    metrics.va_relationship, metrics.shape, metrics.excess, metrics.spike, metrics.one_timeframing, metrics.prominent_poc,
    metrics.revisit_magnets, metrics.dpoc (current, start, path_15m, migration_ticks, migration_speed, stability_ratio, jump),
    metrics.hvn_lvn (hvns_above, hvns_below, lvns_above, lvns_below with price, prominence, method, distance_in_ticks),
    metrics.rth_gap_close, metrics.balance_box, metrics.overlay_15m, metrics.peers
  - day_type, bias, confidence (bucket, score, components)
  - playbooks: list of chosen plays with triggers, entry, exits, invalidation, notes
  - supporting_evidence: array of strings
- Human table includes rows for: Opening Type, IB/RE, Value vs Yesterday, dPOC state, Shape, Morph, HVNs/LVNs nearby, Prominent POC, Spike/Base, Confidence, Day Type, Bias.

## 6) Embedded Playbook Library
```yaml

# === Embedded Unified Playbook Library (v9.4.2) ===
# Coverage: Openings, IB/RE, Gaps (Gap & Go/Fade, RTH Gap Close), Spikes,
# Shapes (P, b, D), Morphs (P->B, b->B, D->P, D->b, Normal->Trend, Neutral->Extreme, Trend->DD),
# Extreme tests (LAB/LBF), Prominent POC magnet, dPOC relocations, HVN/LVN tests.

opening_playbooks:
  - id: OD_with_trend
    label: Open-Drive with higher-timeframe trend
    applicable_when:
      opening_type: "Open-Drive"
    triggers:
      - "Drive away from open with limited counter-test"
      - "Early one-timeframing in drive direction"
    entry: "Go-with on first pullback holding above/below open or spike base"
    exits: ["Distribution node in direction", "VA edge; scale on elongation stall"]
    invalidation: ["Return through open with acceptance", "Break in one-timeframing"]
    notes: "Highest conviction open; do not fight while intact."

  - id: OTD_continuation
    label: Open-Test-Drive continuation
    applicable_when:
      opening_type: "Open-Test-Drive"
    triggers:
      - "Opposite test rejects, then drive resumes"
    entry: "Reclaim of open or IB edge with acceptance (15m provisional -> 30m confirm)"
    exits: ["IB projection", "Next node"]
    invalidation: ["Loss of acceptance back through open", "Failure to extend"]
    notes: "High conviction but a step below OD."

  - id: ORR_reversal
    label: Open-Rejection-Reverse reversal
    applicable_when:
      opening_type: "Open-Rejection-Reverse"
    triggers:
      - "Single-print tail at early extreme then cross back through open"
    entry: "Go-with after one-timeframing begins in new direction"
    exits: ["Prior value edge", "Opposite extreme"]
    invalidation: ["Failure to one-timeframe"]
    notes: "Confidence lower than OD/OTD; rotations likely later."

  - id: OA_balance
    label: Open-Auction balance
    applicable_when:
      opening_type: "Open-Auction"
      open_location_any_of: ["Inside Value","Within Prior Value"]
    triggers:
      - "Two-sided rotation around open; limited extension"
    entry: "Fade extremes toward POC/VA center"
    exits: ["POC","Opposite VA edge"]
    invalidation: ["Acceptance outside prior value or IB with elongation"]
    notes: "Lower conviction; patience and mean reversion."

gap_playbooks:
  - id: gap_and_go_up
    label: Gap & Go Up
    applicable_when:
      gap_type: "Outside_Prior_Range"
      opening_type_any_of: ["Open-Drive","Open-Test-Drive"]
      on_inventory_any_of: ["Too_Short","Balanced"]
    triggers:
      - "Hold above prior range/value (acceptance)"
      - "RE Up within first 1-2 hours"
    entry: "First pullback that holds at spike base/open-test low/IB High"
    exits: ["IB measured move","Developing value highs"]
    invalidation: ["15m close back inside prior range (provisional fail)",
                   "30m close inside prior range (confirmed fail)"]
    notes: "Classic continuation; reduce size if prominent POC forms above."

  - id: gap_and_go_down
    label: Gap & Go Down
    applicable_when:
      gap_type: "Outside_Prior_Range"
      opening_type_any_of: ["Open-Drive","Open-Test-Drive"]
      on_inventory_any_of: ["Too_Long","Balanced"]
    triggers:
      - "Hold below prior range/value (acceptance)"
      - "RE Down within first 1-2 hours"
    entry: "First bounce that holds at spike base/open-test high/IB Low"
    exits: ["IB measured move","Developing value lows"]
    invalidation: ["15m close back inside prior range (provisional fail)",
                   "30m close inside prior range (confirmed fail)"]
    notes: "Mirror of gap & go up."

  - id: gap_fade_down_from_gap_up
    label: Gap Fade Down from Gap Up
    applicable_when:
      gap_type_any_of: ["Outside_Prior_Range","Into_Prior_Range"]
      opening_type_any_of: ["Open-Auction","Open-Rejection-Reverse"]
      on_inventory: "Too_Long"
    triggers:
      - "Failure to extend higher"
      - "15m close back inside prior range"
    entry: "Short back inside prior range after failed retest"
    exits: ["Prior POC/VA center","Opposite extreme if acceptance builds"]
    invalidation: ["Re-escape and 15m hold back outside","30m confirm"]
    notes: "Inventory correction and return to value."

  - id: gap_fade_up_from_gap_down
    label: Gap Fade Up from Gap Down
    applicable_when:
      gap_type_any_of: ["Outside_Prior_Range","Into_Prior_Range"]
      opening_type_any_of: ["Open-Auction","Open-Rejection-Reverse"]
      on_inventory: "Too_Short"
    triggers:
      - "Failure to extend lower"
      - "15m close back inside prior range"
    entry: "Long back inside prior range after failed retest"
    exits: ["Prior POC/VA center","Opposite extreme if acceptance builds"]
    invalidation: ["Re-escape and 15m hold back outside","30m confirm"]
    notes: "Inventory correction and return to value."

rth_gap_close_playbooks:
  - id: rth_gap_close_up_fade
    label: RTH Gap Close - Fade Down (from Gap Up)
    applicable_when:
      rth_gap_dir: "Up"
      day_type_any_of: ["D","Neutral","Balance","Normal","Normal-Variation"]
    triggers:
      - "Progress toward prior close; failure to extend higher"
    entry: "Short toward prior close once acceptance back inside is seen"
    exits: ["At/near prior close","POC/VA center if momentum continues"]
    invalidation: ["Re-escape above prior range with acceptance","Peer gap close against bias = caution"]
    notes: "Common D-day behavior; watch peers for timing."

  - id: rth_gap_close_down_fade
    label: RTH Gap Close - Fade Up (from Gap Down)
    applicable_when:
      rth_gap_dir: "Down"
      day_type_any_of: ["D","Neutral","Balance","Normal","Normal-Variation"]
    triggers:
      - "Progress toward prior close; failure to extend lower"
    entry: "Long toward prior close once acceptance back inside is seen"
    exits: ["At/near prior close","POC/VA center if momentum continues"]
    invalidation: ["Re-escape below prior range with acceptance","Peer gap close against bias = caution"]
    notes: "Common D-day behavior; watch peers for timing."

ib_re_playbooks:
  - id: ib_breakout_success
    label: IB Breakout Success
    applicable_when:
      re_status_any_of: ["Provisional","Confirmed"]
    triggers:
      - "RE beyond IB with time acceptance and elongation"
    entry: "Go-with on pullback to IB edge that holds with 15m acceptance"
    exits: ["Next distribution node","IB projection"]
    invalidation: ["30m close back inside IB"]
    notes: "Attempted direction validated; do not fade until one-timeframing breaks."

  - id: ib_breakout_failure_balance
    label: IB Breakout Failure -> Balance
    applicable_when:
      re_status: "Failure"
    triggers:
      - "Probes beyond IB return quickly inside"
    entry: "Fade IB extremes toward POC"
    exits: ["POC","Opposite IB edge"]
    invalidation: ["Subsequent RE with acceptance"]
    notes: "Rotational day expectations."

spike_playbooks:
  - id: spike_next_day_up
    label: Next Day After Late Spike Up
    applicable_when:
      spike_present: true
    triggers:
      - "Open and hold above Spike Base (acceptance)"
    entry: "Go-with on pullback to Spike Base that holds"
    exits: ["Prior spike high","Measured extensions"]
    invalidation: ["Acceptance back below Spike Base"]
    notes: "If open below base, bias flips to rejection/fade."

shape_playbooks:
  - id: shape_P
    label: P-day Short Covering
    applicable_when:
      shape: "P"
    triggers:
      - "Skew up, thin lower tail, upper fatness"
    entry: "Buy pullbacks only with fresh acceptance above POC or IB High"
    exits: ["Next upper node","Scale at POC/VA if no new value develops"]
    invalidation: ["30m close back below POC with dPOC rolling down"]
    notes: "Limited timeframe; avoid chasing vertical moves."

  - id: shape_b
    label: b-day Long Liquidation
    applicable_when:
      shape: "b"
    triggers:
      - "Skew down, thin upper tail, lower fatness"
    entry: "Sell bounces only with acceptance lower"
    exits: ["Next lower node","Scale at POC/VA if no new value develops"]
    invalidation: ["30m close back above POC with dPOC lifting"]
    notes: "Limited timeframe; avoid chasing vertical moves."

  - id: shape_D
    label: D-day Balance
    applicable_when:
      shape_any_of: ["D","Balance"]
    triggers:
      - "High center fatness; stable dPOC; limited RE"
    entry: "Fade extremes toward POC/VA center; LAB/LBF at edges"
    exits: ["POC","Opposite balance edge"]
    invalidation: ["Acceptance outside balance (15m provisional -> 30m confirmed)"]
    notes: "Mean-revert conditions; take profits at POC/edges."

morph_playbooks:
  - id: morph_P_to_B
    label: P to Balance (P->B)
    applicable_when:
      morph_event: "P_to_B"
    triggers:
      - "Profile fattens at center; dPOC stabilizes"
    entry: "Switch to fade extremes; avoid chasing"
    exits: ["POC","Opposite edge"]
    invalidation: ["New acceptance forms above prior upper distribution"]
    notes: "Transition out of short-covering."

  - id: morph_b_to_B
    label: b to Balance (b->B)
    applicable_when:
      morph_event: "b_to_B"
    triggers:
      - "Center fattens; dPOC stabilizes"
    entry: "Switch to fade extremes"
    exits: ["POC","Opposite edge"]
    invalidation: ["New acceptance forms below prior lower distribution"]
    notes: "Transition out of long-liquidation."

  - id: morph_D_to_P
    label: D to P (late breakout up)
    applicable_when:
      morph_event: "D_to_P"
    triggers:
      - "Tight D box; early 15m acceptance above; RE up"
    entry: "Go-with breakout; buy pullbacks to box top"
    exits: ["IB projection","Next node"]
    invalidation: ["Return and acceptance back inside box"]
    notes: "Avoid fading until one-timeframing breaks."

  - id: morph_D_to_b
    label: D to b (late breakdown)
    applicable_when:
      morph_event: "D_to_b"
    triggers:
      - "Tight D box; early 15m acceptance below; RE down"
    entry: "Go-with breakdown; sell bounces to box bottom"
    exits: ["Next lower node"]
    invalidation: ["Return and acceptance back inside box"]
    notes: "Avoid fading until one-timeframing breaks."

  - id: morph_Normal_to_Trend
    label: Normal -> Trend morph
    applicable_when:
      day_type_prev: "Normal"
      day_type_now_any_of: ["Trend Up","Trend Down"]
    triggers:
      - "Later-session elongation with acceptance"
    entry: "Go-with on pullback; use one-timeframing as guardrail"
    exits: ["Next nodes in direction"]
    invalidation: ["Break of one-timeframing or return to IB"]
    notes: "Rare but important when it happens."

  - id: morph_Neutral_to_Extreme
    label: Neutral -> Neutral-Extreme morph
    applicable_when:
      day_type_prev: "Neutral"
      day_type_now: "Neutral-Extreme"
    triggers:
      - "Late initiative takes control into close"
    entry: "Go-with; bias carries to next session unless rejected"
    exits: ["End-of-day target or spike rules"]
    invalidation: ["Loss of acceptance at extreme"]
    notes: "Expect carry-over if spike accepted."

  - id: morph_Trend_to_DD
    label: Trend -> Double-Distribution morph
    applicable_when:
      day_type_prev_any_of: ["Trend Up","Trend Down"]
      day_type_now: "Double-Distribution"
    triggers:
      - "Midday pause builds second distribution"
    entry: "Rejoin on break from midday balance (second auction)"
    exits: ["Measured move from second distribution"]
    invalidation: ["Failure back into midday balance"]
    notes: "Classic DD development."

extreme_tests:
  - id: look_above_fail
    label: Look Above and Fail (balance edge)
    applicable_when:
      context: "balance_extreme_probe"
    triggers:
      - "Probe above balance extreme fails; quick return inside"
    entry: "Short back inside; traverse toward opposite extreme"
    exits: ["Opposite balance extreme"]
    invalidation: ["Acceptance above the extreme"]
    notes: "Mean-reversion traversal."

  - id: look_below_fail
    label: Look Below and Fail (balance edge)
    applicable_when:
      context: "balance_extreme_probe"
    triggers:
      - "Probe below balance extreme fails; quick return inside"
    entry: "Long back inside; traverse toward opposite extreme"
    exits: ["Opposite balance extreme"]
    invalidation: ["Acceptance below the extreme"]
    notes: "Mean-reversion traversal."

hvn_lvn_playbooks:
  - id: lvn_reject_to_hvn
    label: LVN Rejection -> Rotate to HVN
    applicable_when:
      lvn_tested: true
      rejection_seen: true
    triggers:
      - "Price taps LVN and rejects (wick/return inside)"
    entry: "Enter toward nearest HVN in rotation direction"
    exits: ["Nearest HVN","POC if closer"]
    invalidation: ["Acceptance builds through LVN (15m provisional -> 30m confirmed)"]
    notes: "Auctions avoid thin spots and re-balance at fat nodes."

  - id: lvn_break_accept
    label: LVN Break and Accept -> Traverse to Next Node
    applicable_when:
      lvn_broken: true
      acceptance_beyond_lvn: true
    triggers:
      - "Sustained trade beyond LVN; low resistance path"
    entry: "Go-with toward next HVN/node"
    exits: ["Next HVN/node boundary"]
    invalidation: ["Return back inside and loss of acceptance"]
    notes: "Once through thin areas, price can travel quickly."

  - id: hvn_reject_back_to_balance
    label: HVN Rejection -> Back to Balance
    applicable_when:
      hvn_tested: true
      rejection_seen: true
    triggers:
      - "Test into HVN fails to find continuation"
    entry: "Fade back toward POC/balance center"
    exits: ["POC","Opposite edge"]
    invalidation: ["Acceptance persists inside HVN with elongation"]
    notes: "HVNs can act like 'bear traps' for late chasers."

risk_cautions:
  - id: prominent_poc_magnet
    label: Prominent POC Magnet
    applicable_when:
      prominent_poc: true
    triggers:
      - "Wide TPO row at POC; rotation behavior"
    entry: "Reduce size when trading away from POC; consider mean reversion"
    exits: ["POC as magnet"]
    invalidation: ["Elongation away from POC with acceptance"]
    notes: "POC often pulls price back."

dpoc_relocation_playbooks:
  - id: dpoc_relocation_up
    label: dPOC Relocation Up
    applicable_when:
      dpoc_jump: "Up"
    triggers:
      - "POC jumps higher; acceptance at new level"
    entry: "Buy pullbacks to new POC"
    exits: ["Next upper node"]
    invalidation: ["Acceptance back at old POC"]
    notes: "Structural change; align to new center."

  - id: dpoc_relocation_down
    label: dPOC Relocation Down
    applicable_when:
      dpoc_jump: "Down"
    triggers:
      - "POC jumps lower; acceptance at new level"
    entry: "Sell bounces to new POC"
    exits: ["Next lower node"]
    invalidation: ["Acceptance back at old POC"]
    notes: "Structural change; align to new center."

```

## 7) Notes and Cautions
- Acceptance is time-at-price, not a tag; treat 15m signals as provisional until 30m confirms.
- Do not fade one-timeframing until it breaks.
- Prominent POC can magnetize price; reduce size when trading away from it.
- HVN/LVN: auctions often "skip" LVNs and rest at HVNs; use this as structure for targets and invalidations.
- If 30m and 15m disagree, 30m sets narrative; 15m times entries.
