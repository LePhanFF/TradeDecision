# Dalton TPO Analysis Prompt (V9.1)

## Assumptions
- Symbols: ES, NQ, YM; data = 5-min CSVs.
- Timestamps: tz-naive **US/Eastern** (no conversion).
- **RTH window:** 09:30–16:00 (used for open/close/gap refs).
- **Profiles:** Use **HL2** (OHLC midpoints). Do **not** use VWAP/EMA for VA/POC.
- **Value Area:** **68%** via **adjacent expansion around POC**.
- **Tick size:** ES 0.25, NQ 0.25, YM 1.0.
- **Gap logic:** RTH open = first **09:30** open; prior close = **prior day 16:00** close. “Closed” when RTH trades through prior close.
- Project rule: If **any** index **closes its RTH gap**, emit a **Gap-Closure Warning** (potential order-flow flip); reassess bias with SMT and ONH/ONL/VA edges.

## Core Tasks (V9 outputs kept)
1) **Pick session:** Use the **latest RTH** date that has bars in 09:30–16:00.
2) **Today’s profile (HL2):** Compute **POC, VAL, VAH** (68% expansion).
3) **HVN/LVN nodes:** List top nodes with:
   - `price`, **`range68: [low, high]`**, **`importance (0–5)`**.
4) **Previous-day POC:** Compute prior RTH profile; output `previous_day_POC` and `POC_vs_previous` ∈ {opening above/at/below}.
5) **Gap analysis:** `direction` (UP/DOWN/FLAT), `points` (open − prior close), `closed` (bool).
6) **POC rolling tracking:**
   - **Developing POC (15m cumulative)** array: checkpoints from 09:30 with `POC/VAL/VAH`.
   - **Rolling 60-min POC/VA** array (sliding window).
   - **`rolling_POC_trend_15m`** ∈ {higher/lower/flat}.
7) **Composite context:**
   - **Prior 1–3 sessions:** for each, output `POC/VAL/VAH` + HVN/LVN nodes (with 68% ranges & importance).
   - **Weekly composite** (last **5 RTH** sessions): composite profile `POC/VAL/VAH` + HVN/LVN nodes.
8) **Playbook (print concise, numeric-anchored):**
   - **Bias** (based on POC posture vs prior POC, POC migration, gap status).
   - **Entries:** initiate at **VAH/VAL** or **post-BOS + acceptance**; avoid mid-profile.
   - **Scaling:** first scale at **POC**, second toward **VAL/VAH** once accepted.
   - **Risk notes:** 10:30 gate; **shorts require** (rejection at VAH/gap) **AND** (POC shift down **or** VWAP rejection). Emit **Gap-Closure Warning** per rule.
9) **Opening type (Dalton):** Classify **OIR/OOR/OD/OTD/ORR** with `confidence_0_5` and 1–2 line rationale (use 09:30 vs prior value/range + early IB behavior).
10) **Time-of-Day framework:** Add notes for windows:
    - **09:30–10:30 (IB)**, **10:30–12:00**, **12:00–13:30**, **13:30–15:30**; 2–4 sentences each with numeric refs.
11) **Day-morphing note:** If structure shifts (e.g., D→P, D→b, D→B), output `{from, to, trigger, time}` with a one-line evidence comment.
12) **(Optional) TFS:** `tfs = session_range_points / elapsed_hours`; score 0–5 and short comment (“trend-like” vs “balance-like”).
13) **(Optional) SMT note:** Brief cross-index divergence callout (leader/laggard; bullish/bearish/neutral), only if clear.

## Day-Type Validation (V9.1)
Compute metrics (numbers required):
- `hi`, `lo`, `range = hi − lo`
- `poc_pos_0to1 = (POC − lo) / range`  (Bottom ≤ 0.34; Middle 0.34–0.66; Top ≥ 0.66)
- `va_width = VAH − VAL`, `va_ratio = va_width / range`
- **Bimodality test (B candidate):** two HVNs separated by ≥ **0.20×range** with a **deep LVN** between (LVN vol ≤ **30%** of smaller HVN).
- **IB extension (09:30–10:30):** `ib_ext.up`, `ib_ext.dn` as fractions of range.
- **POC slope (15m):** direction + Δ from first to last checkpoint.
- **Gap context:** `gap.direction`, `gap.closed`.
- **(Optional) TFS value**.

**Deterministic classification:**
- If **bimodality** → **B**.
- Else **P** if `poc_pos ≥ 0.66` **and** `ib_ext.up ≥ 0.25` **and** `va_ratio ≤ 0.55`.
- Else **b** if `poc_pos ≤ 0.34` **and** `ib_ext.dn ≥ 0.25` **and** `va_ratio ≤ 0.55`.
- Else **D**.
**Tie-breakers:**
- Extreme `poc_pos` (≥0.80 or ≤0.20) **but** weak IB (<0.15) **and** wide VA (`va_ratio ≥ 0.50`) → prefer **D**.
- If **gap.closed = True** against initial impulse and **POC slope disagrees**, down-weight P/b → **D**.

**Score & confidence:**
- Subscores (0–100): **POC Position 30%**, **VA Ratio 20%**, **IB 20%**, **POC Slope 15%**, **Bimodality 10%**, **Gap 5%**.  
- If IB missing, renormalize weights.  
- `confidence = 0.40 + 0.40*(score/100)` (clip 0.40–0.80).

**Evidence comments (3–6 bullets, numeric):**
- `POC at {poc_pos:.2f} of range ({POC} within [{lo}, {hi}]).`
- `VA width {va_width} = {va_ratio:.2f}× range.`
- `IB extension up/down: {ib_ext.up:.2f}/{ib_ext.dn:.2f}.` (if available)
- `Bimodality: {True/False}, HVNs {h1,h2}, LVN_between {l_between}.`
- `POC slope (15m): {higher/lower/flat} (Δ={delta}).`
- `Gap {UP/DOWN} {points:+.2f}, closed={True/False}.`

## Output Schema (per instrument)
{
  "instrument": "ES|NQ|YM",
  "session_date": "YYYY-MM-DD",
  "now_dt": "YYYY-MM-DD HH:MM:SS",

  "open_close_refs": {
    "RTH_open_09_30": 0.0,
    "prior_close_16_00": 0.0,
    "prior_close_date": "YYYY-MM-DD"
  },

  "gap": { "direction": "UP|DOWN|FLAT", "points": 0.0, "closed": true|false },

  "profile": { "POC": 0.0, "VAL": 0.0, "VAH": 0.0 },

  "HVN_list": [ { "price": 0.0, "range68": [0.0, 0.0], "importance": 0 }, ... ],
  "LVN_list": [ { "price": 0.0, "range68": [0.0, 0.0], "importance": 0 }, ... ],

  "previous_day_POC": 0.0,
  "POC_vs_previous": "opening above|at|below prior POC",

  "rolling": {
    "developing_POC_15m": [ { "dt": "...", "POC": 0.0, "VAL": 0.0, "VAH": 0.0 }, ... ],
    "rolling_POC_60m":   [ { "dt": "...", "POC_60m": 0.0, "VAL_60m": 0.0, "VAH_60m": 0.0 }, ... ],
    "rolling_POC_trend_15m": "higher|lower|flat"
  },

  "prior_sessions": [
    { "date": "YYYY-MM-DD", "POC": 0.0, "VAL": 0.0, "VAH": 0.0,
      "HVN_list": [...], "LVN_list": [...] }, ...
  ],
  "weekly_composite": {
    "dates": ["YYYY-MM-DD", ...],
    "POC": 0.0, "VAL": 0.0, "VAH": 0.0,
    "HVN_list": [...], "LVN_list": [...]
  },

  "opening_type": { "label": "OIR|OOR|OD|OTD|ORR", "confidence_0_5": 0, "rationale": "..." },

  "time_of_day_notes": [
    { "window": "09:30–10:30", "note": "..." },
    { "window": "10:30–12:00", "note": "..." },
    { "window": "12:00–13:30", "note": "..." },
    { "window": "13:30–15:30", "note": "..." }
  ],

  "day_morphing": { "from": "D|P|b|B", "to": "D|P|b|B", "trigger": "...", "time": "HH:MM" },

  "day_type_primary": "P|b|D|B",

  "day_type_validation": {
    "metrics": {
      "hi": 0.0, "lo": 0.0, "range": 0.0,
      "poc_pos_0to1": 0.00,
      "va_width": 0.0, "va_ratio": 0.00,
      "bimodality": { "is_bimodal": false, "hvn_prices": [], "lvn_between": [] },
      "ib_ext": { "up": null, "dn": null },
      "poc_slope_15m": { "direction": "higher|lower|flat", "delta": 0.0 },
      "gap": { "direction": "UP|DOWN|FLAT", "closed": false },
      "tfs": 0.0  // optional
    },
    "classification": {
      "label": "P|b|D|B",
      "score_0_100": 0,
      "confidence_0_1": 0.60,
      "decision_path": ["..."],
      "subscores": { "pos":0, "va":0, "ib":0, "slope":0, "bimo":0, "gap":0 },
      "weights":   { "pos":0.30, "va":0.20, "ib":0.20, "slope":0.15, "bimo":0.10, "gap":0.05 }
    },
    "evidence_comments": [ "...", "...", "..." ]
  },

  "playbook": {
    "bias": "...",
    "entries": "...",
    "scaling": "...",
    "risk_notes": [
      "Gap-closure warning if any index closed its gap.",
      "10:30 gate.",
      "Short confirmations require rejection at VAH/gap AND (POC shift down OR VWAP rejection).",
      "On D days, initiate only at VAH/VAL or post-BOS + acceptance; POC = first scale/magnet."
    ]
  },

  "validation_appendix": {
    "09_30_open_from_OHLC": 0.0,
    "16_00_prior_close_from_OHLC": 0.0,
    "price_ref": "HL2 (OHLC midpoints)",
    "value_area_method": "68% adjacent expansion around POC",
    "tick_size_used": 0.25,
    "value_area_width": 0.0,
    "hvn_lvn_notes": "Top HVN/LVN nodes include 68% ranges and anchor prices."
  }
}

## Messaging
- Always print a **Gap-Closure Warning** if any `gap.closed = true`.
- **Never** use VWAP/EMA for VA/POC (HL2 only). VWAP may be cited in *evidence* for rejections.
- On **D** days: entries at **VAH/VAL** or **post-BOS + acceptance**; **POC** = first scale/magnet.
- **Shorts require BOTH:** (rejection at VAH/gap) **AND** (POC shift down **or** VWAP rejection).
- **10:30 Gate:** No counter-trend risk into impulse before 10:30 unless clean rejection + acceptance.

