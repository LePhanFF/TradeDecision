# Dalton TPO Analysis Prompt (V9.2) — Spec

_This is the V9.2 spec (pre‑9.2.1). It preserves V9.1’s deterministic engine and adds richer context: expanded POC migration tracking, weekly composite, time‑of‑day notes, morphing, and ICT‑adjacent hooks. No external YAML wiring in this version._

---

## Assumptions
- Instruments: **ES, NQ, YM** (CME). Primary data: **5‑minute** CSV (optionally 1‑minute for ON session context).
- **Timestamps:** tz‑naive **US/Eastern** (do **not** convert).
- **Sessions:** **RTH 09:30–16:00 ET**; **ON 18:00–09:29 ET**.
- **Profile price basis:** **HL2** = (H+L)/2 for TPO/volume distributions.
- **Value Area:** **68%** via **adjacent expansion around POC** (not Gaussian; do not use VWAP/EMA for VA/POC math).
- **Tick size:** ES 0.25, NQ 0.25, YM 1.0.
- **Gap logic:** RTH open = first **09:30** open; prior close = **prior 16:00** close; `gap.closed=true` once RTH trades **through** prior close.

---

## Core Tasks (V9.2)
1) **Pick session**: Latest RTH date with bars in 09:30–16:00.
2) **Today’s RTH profile (HL2)**: Compute **POC, VAL, VAH** (68% expansion around POC).
3) **HVN/LVN nodes**: List nodes with `{price, range68:[low, high], importance(0–5)}`.
4) **Previous‑day profile**: Prior RTH POC/VAL/VAH; output `previous_day_POC` and `POC_vs_previous ∈ {opening above|at|below}`.
5) **Gap analysis**: `{direction, points, closed}` based on 09:30 open vs prior 16:00 close.
6) **POC rolling tracking** (expanded vs V9.1):
   - **Developing POC/VA 15‑minute checkpoints**: from 09:30, array of `{dt, POC, VAL, VAH}`.
   - **Rolling 60‑minute window**: array `{dt, POC_60m, VAL_60m, VAH_60m}` once 10:30+.
   - **Trend label**: `rolling_POC_trend_15m ∈ {higher|lower|flat}` with numeric `Δ` from first to last checkpoint.
7) **Composite context** (new in 9.2):
   - **Prior 1–3 sessions**: For each, report `POC/VAL/VAH` and top HVN/LVN (w/ 68% ranges & importance).
   - **Weekly composite (last 5 RTH)**: composite `POC/VAL/VAH` + key HVN/LVN nodes.
8) **Time‑of‑Day notes** (new in 9.2): for windows **09:30–10:30 (IB)**, **10:30–12:00**, **12:00–13:30**, **13:30–15:30**; provide 2–4 concise numeric notes each.
9) **Opening type (Dalton)**: Classify **OIR/OOR/OD/OTD/ORR** with `confidence_0_5` and 1–2‑line rationale (use gap vs value and early IB behavior).
10) **Day‑morphing note** (new): If structure shifts (e.g., D→P, D→b, D→B), print `{from, to, trigger, time}` with a one‑line evidence comment.
11) **Optional tempo & cross‑index hooks** (new):
    - **TFS** = `session_range_points / elapsed_hours`; score 0–5, comment (“trend‑like” vs “balance‑like”).
    - **SMT note** (ES/NQ/YM): leader/laggard, bullish/bearish/neutral (only if clear).
12) **Playbook summary** (text): concise `{bias, entries, scaling, risk_notes[]}` grounded in metrics (see Messaging below).

---

## Day‑Type Validation (deterministic — same rules as 9.1)
**Metrics** (numbers required):
- `hi`, `lo`, `range = hi − lo`
- `poc_pos_0to1 = (POC − lo) / range`  (Bottom ≤ 0.34; Middle 0.34–0.66; Top ≥ 0.66)
- `va_width = VAH − VAL`, `va_ratio = va_width / range`
- **Bimodality test (B candidate):** two HVNs separated by ≥ **0.20×range** with **deep LVN** between (LVN vol ≤ **30%** of smaller HVN).
- **IB extension (09:30–10:30):** `ib_ext.up`, `ib_ext.dn` as fractions of range.
- **POC slope (15m):** direction + `Δ` from first to last checkpoint.
- **Gap context:** `gap.direction`, `gap.closed`.
- **(Optional) TFS value**.

**Deterministic classification**:
- If **bimodality** → **B**.
- Else **P** if `poc_pos ≥ 0.66` **and** `ib_ext.up ≥ 0.25` **and** `va_ratio ≤ 0.55`.
- Else **b** if `poc_pos ≤ 0.34` **and** `ib_ext.dn ≥ 0.25` **and** `va_ratio ≤ 0.55`.
- Else **D**.

**Tie‑breakers**:
- Extreme `poc_pos` (≥0.80 or ≤0.20) **but** weak IB (<0.15) **and** wide VA (`va_ratio ≥ 0.50`) → prefer **D**.
- If `gap.closed = true` against initial impulse and **POC slope disagrees**, down‑weight P/b → **D**.

**Score & confidence**:
- Subscores (0–100): **POC Position 30%**, **VA Ratio 20%**, **IB 20%**, **POC Slope 15%**, **Bimodality 10%**, **Gap 5%**.
- If IB missing, renormalize weights.
- `confidence = 0.40 + 0.40*(score/100)` (clip 0.40–0.80).

**Evidence bullets (3–6, numeric)**:
- `POC at {poc_pos:.2f} of range ({POC} within [{lo}, {hi}]).`
- `VA width {va_width} = {va_ratio:.2f}× range.`
- `IB extension up/down: {ib_ext.up:.2f}/{ib_ext.dn:.2f}.` (if available)
- `Bimodality: {True/False}, HVNs {h1,h2}, LVN_between {l_between}.`
- `POC slope (15m): {higher/lower/flat} (Δ={delta}).`
- `Gap {UP/DOWN} {points:+.2f}, closed={True/False}.`

---

## ICT‑Adjacent Hooks (context add‑ons, optional)
- **Reclaims & Sweeps**: Flag PDH/PDL/ONH/ONL/VAH/VAL sweeps → reclaim/acceptance with timestamps.
- **Breaker / “Unicorn” confluence**: score +1..+3 each for BOS/CHOCH alignment, clean FVG, engulf+retrace, SMT divergence, BPR; ±2 if **POC migration alignment** supports/contradicts.
- **Auction Acceptance via Hold**: if reclaimed level holds ≥1h and into 13:00 → set `AuctionAcceptance=true` and note bias upgrade.

---

## Output Schema (V9.2)
```json
{
  "instrument": "ES|NQ|YM",
  "session_date": "YYYY-MM-DD",
  "now_dt": "YYYY-MM-DD HH:MM:SS",
  "open_close_refs": {"RTH_open_09_30": 0.0, "prior_close_16_00": 0.0, "prior_close_date": "YYYY-MM-DD"},
  "gap": {"direction": "UP|DOWN|FLAT", "points": 0.0, "closed": true},
  "profile": {"POC": 0.0, "VAL": 0.0, "VAH": 0.0},
  "HVN_list": [ {"price": 0.0, "range68": [0.0, 0.0], "importance": 0} ],
  "LVN_list": [ {"price": 0.0, "range68": [0.0, 0.0], "importance": 0} ],
  "previous_day_POC": 0.0,
  "POC_vs_previous": "opening above|at|below",
  "rolling": {
    "developing_POC_15m": [ {"dt": "...", "POC": 0.0, "VAL": 0.0, "VAH": 0.0} ],
    "rolling_POC_60m":   [ {"dt": "...", "POC_60m": 0.0, "VAL_60m": 0.0, "VAH_60m": 0.0} ],
    "rolling_POC_trend_15m": "higher|lower|flat",
    "delta_POC_15m": 0.0
  },
  "prior_sessions": [ {"date": "YYYY-MM-DD", "POC": 0.0, "VAL": 0.0, "VAH": 0.0, "HVN_list": [...], "LVN_list": [...] } ],
  "weekly_composite": {"dates": ["YYYY-MM-DD", ...], "POC": 0.0, "VAL": 0.0, "VAH": 0.0, "HVN_list": [...], "LVN_list": [...]},
  "opening_type": {"label": "OIR|OOR|OD|OTD|ORR", "confidence_0_5": 0, "rationale": "..."},
  "time_of_day_notes": [ {"window": "09:30–10:30", "note": "..."}, {"window": "10:30–12:00", "note": "..."}, {"window": "12:00–13:30", "note": "..."}, {"window": "13:30–15:30", "note": "..."} ],
  "day_morphing": {"from": "D|P|b|B", "to": "D|P|b|B", "trigger": "...", "time": "HH:MM"},
  "day_type_primary": "P|b|D|B",
  "day_type_validation": { "metrics": {...}, "classification": {...}, "evidence_comments": ["...", "...", "..."] },
  "ict_adjunct": { "reclaims": [], "breaker_unicorn": {"score": 0, "notes": "..."}, "auction_acceptance": {"flag": false, "since": null} },
  "playbook": { "bias": "...", "entries": "...", "scaling": "...", "risk_notes": ["..."] }
}
```

---

## Messaging (V9.2)
- Always print a **Gap‑Closure Warning** if any `gap.closed=true`.
- **Never** compute VA/POC using VWAP/EMA; HL2 only. VWAP is allowed in **evidence** for rejections.
- On **D** days: initiate at **VAH/VAL** or post‑BOS + acceptance; **POC** = first scale/magnet.
- **Shorts require BOTH:** (rejection at VAH/gap) **AND** (POC shift down **or** VWAP rejection).
- **10:30 Gate:** No counter‑trend risk into impulse before 10:30 unless clean rejection + acceptance.
