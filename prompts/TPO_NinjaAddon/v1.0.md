ROLE
You are a senior / architect NinjaTrader 8 Add-On engineer and Auction Market Theory educator. Produce a single, compilable NinjaTrader 8 Add-On in C# that implements the COMPLETE “TPO Analysis v9.4.3 (FULL)” prompt locally, using live 5-minute OHLC bars from NinjaTrader’s BarsRequest API. Do not ask clarifying questions—assume all requirements are final and deliver the code and run instructions in one shot.

OBJECTIVE
Build a thread-safe NT8 Add-On that:
1. Subscribes to NQ, ES, YM (##-## continuous or active expiry).
2. Every 5-minute closed bar:
   - Updates internal Auction/TPO state.
   - Computes all metrics from TPO Analysis v9.4.3 (FULL).
   - Stores structured results as JSON (machine-readable, verbose, forward-compatible).
   - Emits human-readable tables and commentary (journal style).
3. Minimal UI: Control Center “New” menu item toggles Start/Stop.
4. Versioning: v9.4.3 in menu, code, filenames, and JSON schema version fields.

DATA & SESSIONS
- Inputs: 5m OHLC from BarsRequest.
- Trading hours: Prefer TradingHours.Get("CME US Index Futures ETH"); compute RTH profile using the RTH segment of the template; optionally compute ON (ETH-only) metrics when available.
- Prior-day references for each instrument: H/L, TPO VAH/POC/VAL, (and Volume VAH/POC/VAL if accessible); roll these at RTH close.
- Missing inputs must degrade confidence with explicit “degradedBy: [...]” reasons.

METRICS TO IMPLEMENT (superset v9.3 → v9.4.2)
- Opening location vs prior value/range (inside value / outside value / in-range / out-of-range; gap magnitude in ticks).
- Opening type (OD / OTD / ORR / OA) with rationale.
- Initial Balance (IB) tracking and IB extensions (count & magnitude by side).
- Developing POC (dPOC) tracking and 15-minute rolling migration series.
- Full TPO value area (VAH, VAL, POC) using 70% TPO rule (time-price, not volume).
- HVN/LVN arrays (identify via TPO density extrema; stabilized with smoothing; each tagged with strength).
- Peer gap-close tracking across ES/NQ/YM (did “today” touch prior settle/close? did peers confirm?).
- Morphology detection (P-day, b-day, D-day, B-day / double distribution; live morph updates with evidence).
- Single prints (price runs with one TPO), poor highs/lows (no excess), one-timeframing by timeframe.
- Day-type classification with morph logic (prior call, current call, confidence, reason trails).
- Dynamic confidence scoring: weighted components (opening context, IB, acceptance, dPOC migration, peers, excess/singles, OTF, structure symmetry).
- Educational playbooks (gap-and-go, IB breakout continuation/failure, failed auction, double distribution continuation), with trigger conditions and evidence.

UI REQUIREMENTS (basic, clean)
- A text field showing last time updated.
- A text box showing human-readable commentary (similar to v9.4.3 “chat mode”). Do not echo raw JSON. For each entry, print timestamp in Eastern Time (HH:mm).
- Directional bias widget (bullish/neutral/bearish) with green/yellow/red flags.
- Day-type classification widget.
- “Evidence” text box (key facts that justify the call).
- Graph tracking developing POC migration (simple 2D polyline over the current session).
- Confidence score/grade from the JSON object.
- Morph warning widget (icon/flag) with brief cited evidence when morphology risk is elevated or state changed.

BAR-PROCESSING RULES
- Process only CLOSED bars (indices ≤ Count-2).
- Track lastProcessedIndex per instrument to avoid duplicates.
- Update Auction/TPO structures incrementally each closed bar; no full recompute each tick.
- At RTH open, start new session structures; at RTH close, finalize and persist a session summary; roll references for the next session.
- All timestamps stored in UTC with a companion ET field for display; ET uses Windows TZ “Eastern Standard Time” (with DST).

ARCHITECTURE (required structure)
- AddOn class: `NinjaAddOnTPOV943` (NinjaTrader.NinjaScript.AddOns).
- Modules (internal classes or separate files under /src):
  - DataEngine: BarsRequest management, session segmentation (RTH/ON), per-instrument state; thread-safe.
  - ProfileBuilder: builds/updates TPO histogram, VAH/POC/VAL (70% around POC), HVN/LVN detection with smoothing; tracks single prints and poor highs/lows.
  - Classifier: opening type, day-type, morph logic, OTF checks, peer coherence; weighs components to produce confidence.
  - PeersModel: cross-index gap and confirmation logic.
  - JsonStore: JSONL writer (bar-level updates) and session summary writer; handles schema versioning, atomic writes.
  - Journal: formats human-readable commentary lines (ET HH:mm); appends to log and Output window.
  - UiHost: WPF Add-On window with simple grid layout (labels, text boxes, colored flags, dPOC polyline). All UI changes via Dispatcher.
  - Clock/TZ: UTC↔ET helpers and formatting.
- Concurrency: stateLock for shared state; fileLock for IO; headerPrinted via Interlocked; aggressive try/catch with tagged errors.

JSON OUTPUT (verbose, forward-compatible)
- Storage base: Core.Globals.UserDataDir\NinjaAddOn\TPOv943\
- Directory convention:
  - {base}/{symbol}/
    - daily/{YYYY-MM-DD}/bars.jsonl                (bar-by-bar records, one JSON per line)
    - daily/{YYYY-MM-DD}/session_summary.json      (one JSON at RTH close, full day profile)
    - latest/{symbol}_latest.json                  (last computed snapshot for quick reads)
    - logs/{YYYY-MM-DD}.log                        (human-readable journal)
- Schema:
  - schemaVersion: "tpo.v9_4_3"
  - producer: "NinjaAddOnTPOV943"
  - instrument: { symbol, fullName, expiry, tickSize, pointValue }
  - timezone: { etId: "Eastern Standard Time", etOffsetMinutes, isDst }
  - priorDayRefs: { rthHigh, rthLow, vah, poc, val, settle, volumeVah?, volumePoc?, volumeVal? }
  - rthSession: { openEt, closeEt, ibMinutes: 60, tpoLetterMinutes: 30 }
- JSONL (bar record) fields (each line):
  {
    "schemaVersion":"tpo.v9_4_3",
    "type":"bar",
    "ts_utc":"2025-09-28T14:35:00Z",
    "ts_et":"2025-09-28T10:35:00-04:00",
    "sessionId":"2025-09-28-RTH",
    "instrument":{"symbol":"ES","fullName":"ES 12-25","expiry":"2025-12","tickSize":0.25,"pointValue":50},
    "bar":{"o":5000.75,"h":5001.00,"l":4999.25,"c":5000.50},
    "context":{
      "rthPhase":"RTH",
      "sinceOpenMin":65,
      "gap":{"dir":"up|down|none","ticks":12,"closed":true},
      "opening":{"location":"inValue|inRange|outOfValue|outOfRange","type":"OD|OTD|ORR|OA"}
    },
    "ib":{"high":5012.25,"low":4998.50,"extensions":{"up":1,"down":0}},
    "profile":{
      "tpo":{"poc":5006.50,"vah":5010.25,"val":5002.50,"letters":30,"totalTpos":N},
      "hvn":[{"price":5014.00,"score":0.82},{"price":5006.50,"score":0.91}],
      "lvn":[{"price":5009.00,"score":0.78}],
      "singles":[{"start":5011.25,"end":5012.00,"when":"2025-09-28T11:05:00-04:00"}],
      "poor":{"high":false,"low":true}
    },
    "developing":{
      "dPoc":5006.50,
      "dPocTrail":[{"t":"10:00","p":5005.75},{"t":"10:15","p":5006.25},{"t":"10:30","p":5006.50}]
    },
    "structure":{
      "oneTimeframing":{"up":false,"down":true,"frame":"5m|30m"},
      "shape":"P|b|D|B|Trend|Neutral|NonTrend",
      "morph":{"risk":"low|med|high","from":"D","to":"B","evidence":["late IS singles","dPOC shift down > 2t"]}
    },
    "peers":{
      "es":{"gapClosed":true},
      "nq":{"gapClosed":false},
      "ym":{"gapClosed":true},
      "coherenceScore":0.67
    },
    "call":{
      "bias":"bullish|bearish|neutral",
      "dayType":"P|b|D|B|Trend|Neutral|NonTrend",
      "confidence":72,
      "reasons":["Open above value and held","IB breakout up w/ OTF up"],
      "warnings":["Morph risk to B-day if singles don't fill"]
    }
  }
- Session summary (written at RTH close): type:"session"
  {
    "schemaVersion":"tpo.v9_4_3",
    "type":"session",
    "sessionId":"2025-09-28-RTH",
    "instrument":{...},
    "rth":{"openEt":"09:30","closeEt":"16:00"},
    "ranges":{"high":..., "low":..., "trueRange":...},
    "tpo":{"poc":..., "vah":..., "val":..., "tpoCounts":[{"price":..., "count":...}, ...]},
    "hvn":[{"price":..., "score":...}, ...],
    "lvn":[{"price":..., "score":...}, ...],
    "ib":{"high":..., "low":..., "extentUpTicks":..., "extentDownTicks":...},
    "singles":[...], "poor":{"high":bool,"low":bool}, "otf":{"up":bool,"down":bool,"frames":["30m","5m"]},
    "peerSummary":{"es":{"gapClosed":...}, "nq":..., "ym":...},
    "finalCall":{"dayType":"...", "bias":"...", "confidence":.., "reasons":[...], "warnings":[...]},
    "nextDayCarry":{"vah":..., "poc":..., "val":..., "settle":...}
  }

ALGORITHMS (implementation detail)
- TPO building:
  - Use tickSize grid; a 5-minute bar contributes TPOs at each price level touched by bar range (inclusive) snapped to tick; assign a letter by 30-minute TPO period (config: const int TPO_LETTER_MINUTES = 30). Maintain {price -> count, lettersSet}.
  - POC = price with max TPO count (if tie: nearest to mid-price, else highest count then nearest to session VWAP if computed).
  - Value Area: starting at POC, expand up/down alternating toward higher count until covering ≥ 70% of total TPOs.
  - HVN/LVN: compute a 3-point local maxima/minima over smoothed counts (SMA(3)); retain levels above 75th percentile (HVN) or below 25th (LVN); debounce by requiring persistence ≥ 2 TPO periods.
- IB:
  - IB window = first 60 minutes of RTH; IB high/low; count extensions: number of 5m bars that set new session highs/lows outside IB by ≥ 1 tick (track cumulative ticks by side).
- Opening context:
  - Compare RTH open vs prior VAH/VAL and prior range; label location and compute gaps in ticks; OD/OTD/ORR/OA per Dalton-style rules (document in code comments).
- One-timeframing:
  - For frame ∈ {30m, 5m}: up if each high > prior high and lows not violated; down symmetric.
- Single prints & poor highs/lows:
  - Single prints: one-TPO wide areas that are not overlapped by later periods; poor = lack of excess (no tail of ≥ 2 TPOs) at session extreme.
- Day-type classification:
  - “Trend” if persistent OTF with large range and few rotations, no meaningful counter-rotations; “Double Distribution (B)” if clear mid-session single prints splitting two distributions; “P/b” if asymmetry with top/bottom tail and low opposite development; “D/Neutral/NonTrend” by rotational criteria and IB relationship. Include morph tracking: original call vs current, with evidence strings.
- Peers:
  - For ES/NQ/YM compute prior-settle/close gap and record gapClose boolean when any bar touches prior settle; compute coherenceScore = fraction peers confirming same bias/gap behavior.
- Confidence:
  - Weighted sum [opening(15), IB(15), acceptance/VA proximity(15), dPOC trend(15), OTF(15), peers(10), structure symmetry/excess/singles(15)]; clamp 0..100. Degrade by -5 each missing component with "degradedBy" list.

THREAD-SAFETY REQUIREMENTS
- UI marshaling via WPF Dispatcher only.
- Shared state (requests, per-instrument profile, lastProcessedIndex) protected by stateLock.
- File IO serialized via fileLock; use AppendAllLines with buffered batches.
- Header printing and status “last updated” gate via Interlocked.
- Safe shutdown: unsubscribe Update handlers; Cancel + Dispose BarsRequest; ignore in-flight updates when isRunning = false.

OUTPUT WINDOW (journal format)
- Header printed once.
- For each closed bar (ET HH:mm), print:
  HH:mm  ES  Bias=Bul  Day=P  Conf=72  IB[H/L]=5012.25/4998.50  dPOC=5006.50 → 5006.75  VA[VAL/POC/VAH]=5002.50/5006.50/5010.25  Singles:1  OTF:Down(5m)  Morph:Low
- Commentary lines (bulleted) explaining evidence succinctly.

UI IMPLEMENTATION NOTES
- Add-On window with a grid:
  - Top row: “Last Updated (ET): HH:mm:ss” (bound to snapshot).
  - Left: Text area (read-only) streaming commentary.
  - Right-top: colored bias flag (green/yellow/red), day-type label, confidence score (0–100).
  - Right-mid: “Evidence” box (short bullet list).
  - Right-bottom: dPOC migration mini-graph (Polyline; X=time buckets, Y=price scaled to panel).
  - Morph warning icon (triangle) with tooltip containing most recent morph evidence.
- Do not block UI thread; all updates are dispatched asynchronously.

DELIVERABLES
1. Brief run instructions (≤ 8 lines) including how to install in NT8, open Output, and start/stop the Add-On.
2. A complete, compilable NinjaTrader 8 Add-On C# codebase (no placeholders) that builds from the NinjaScript Editor.
3. Pack the code into a ZIP archive named `TPOv943_AddOn.zip` with structure:
   /src/AddOn/NinjaAddOnTPOV943.cs
   /src/Core/DataEngine.cs
   /src/Core/ProfileBuilder.cs
   /src/Core/Classifier.cs
   /src/Core/PeersModel.cs
   /src/Core/JsonStore.cs
   /src/Core/Journal.cs
   /src/Core/ClockEt.cs
   /src/Ui/UiHostWindow.cs
   /LICENSE.txt
   /README.md
   (Provide the full contents inline and also as a single code block suitable for copy/paste; include instructions to create the ZIP.)
4. Code must include:
   - Full TPO analysis logic per v9.4.3.
   - JSON writer + journal logger (paths as specified).
   - Thread-safe design as above.
   - Simple UI widgets per the UI REQUIREMENTS section.

FUTURE-USE CONSIDERATIONS (must influence design & JSON today)
- JSON will be consumed by separate indicators to plot LVN/HVN/POC/VAH/VAL, prior-day VAH/VAL/POC, IB, and B-day inflection points.
- Keep JSON stable, explicit, and verbose: arrays of {price, score}, typed fields, and explicit timestamps.
- Provide `latest/{symbol}_latest.json` snapshot for low-latency indicator reads (atomic write pattern: write temp, then move).
- Prefer flat arrays for price levels (TradingView & other consumers parse JSON best with simple arrays).
- Enumerations should be strings (not ints) and documented in README.md.
- Round price fields to instrument tickSize; include tickSize and pointValue in every record for consumer convenience.

INSTALL & RUN (target output of your response)
1) Open NinjaTrader 8 → New → NinjaScript Editor.
2) Right-click → New → Add On… → name `NinjaAddOnTPOV943`.
3) Replace generated file(s) with provided /src contents, preserving namespaces.
4) Compile (F5) → Connect your data feed.
5) Open New → NinjaScript Output (for logs).
6) Open New → “NinjaAddOn TPO v9.4.3” menu entry to Start/Stop.
7) Verify files under `…\Documents\NinjaTrader 8\NinjaAddOn\TPOv943\`.
8) Observe UI window updates, Output journal, and JSON files updating every closed 5-minute bar.

ACCEPTANCE CHECKLIST
- Compiles and runs as an NT8 Add-On; menu toggles Start/Stop; clean Start/Stop without leaks.
- Produces bar-by-bar JSONL and a session summary JSON per instrument/day; maintains latest snapshot JSON.
- UI shows last updated ET time, bias flag, day-type, confidence, evidence, morph warning, and dPOC graph.
- Journal prints ET HH:mm rows with key metrics and short evidence.
- No duplicate bar processing; all UI updates marshaled via Dispatcher; IO serialized; dictionaries locked.
- TPO/VA/POC/HVN/LVN/single prints/poor highs-lows/OTF/IB implemented as specified; morphology and peers logic operational.
- Confidence score present and responsive; degrades with missing inputs; reasons captured.
