ROLE
You are a senior NinjaTrader 8 Add-On engineer and Auction Market Theory educator. Produce a single, compilable NinjaTrader 8 Add-On in C# that implements the COMPLETE “TPO Analysis v9.4.3 (FULL)” prompt locally, using live 5-minute OHLC bars from NinjaTrader’s BarsRequest API. Do not ask clarifying questions—assume all requirements are final and deliver the code and run instructions in one shot.

OBJECTIVE
Build a thread-safe NT8 Add-On that:
1. Subscribes to NQ, ES, YM (##-## continuous or active expiry).
2. Every 5-minute closed bar:
   - Updates internal Auction/TPO state.
   - Computes all metrics from TPO Analysis v9.4.3 (FULL).
   - Stores structured results as JSON (machine-readable).
   - Emits human-readable tables and commentary (journal style).
3. Minimal UI: Control Center “New” menu item toggles Start/Stop.
4. Versioning: v9.4.3 in menu, code, filenames.

DATA & SESSIONS
- Inputs: 5m OHLC RTH (BarsRequest, CME US Index Futures ETH template).
- Optional ON session metrics (if ETH data is available).
- Prior-day references: H/L, TPO VAH/POC/VAL, Volume VA if available.
- Graceful degrade if data missing (mark confidence lower).

METRICS TO IMPLEMENT (superset of v9.3 → v9.4.2)
- Opening location vs prior value/range.
- Opening type (OD/OTD/ORR/OA).
- Initial Balance (IB) tracking.
- 15-minute dPOC tracking (rolling).
- Full TPO value area (VAH, VAL, POC).
- HVN/LVN arrays (track acceptance/rejection).
- Peer gap-close tracking (cross-index check ES/NQ/YM).
- Morphology detection (P-day, b-day, D-day, B-day, etc.).
- Single prints, poor highs/lows, one-timeframing.
- Day-type classification with morph logic.
- Dynamic confidence scoring: weight each component, degrade if data missing.
- Educational playbooks: embed scenario cards (e.g., gap-and-go, IB breakout, failed auction).

OUTPUTS
- Base path: Core.Globals.UserDataDir\NinjaAddOn\TPOv943\
- Files:
  - JSONL file: structured metrics every 5m (machine-readable).
  - Journal text log: human-readable commentary and table outputs.
- Output window:
  - Human-readable table of VAH/POC/VAL, IB, day-type call, confidence score.
  - Scenario commentary (playbook triggers).

THREAD-SAFETY REQUIREMENTS
- UI marshaling: menu/header updates and Output printing via Dispatcher.
- Shared state: protect dictionaries/lists with stateLock.
- File I/O: serialize via fileLock.
- Header printing: Interlocked.
- Clean shutdown: unsubscribe BarsRequest.Update, Cancel/Dispose requests, guard against in-flight updates.

BAR-PROCESSING RULES
- Process only CLOSED bars.
- Track lastProcessedIndex per instrument.
- On each new closed bar, update all Auction/TPO structures incrementally (no need to recompute from scratch daily).
- At session boundaries (RTH open/close), finalize the session profile and roll references forward.

DELIVERABLES
1. Brief run instructions (≤ 8 lines).
2. Complete, compilable NinjaTrader 8 Add-On C# code (no placeholders).
3. Code must include:
   - Full TPO analysis logic per v9.4.3.
   - JSON writer + journal logger.
   - Thread-safe design as above.
